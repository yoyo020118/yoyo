<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Random - OmeTV Style</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        
        body { 
            background: #111; 
            color: white; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            transition: 0.5s all;
        }

        /* === Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ === */
        #loginScreen {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 20px; text-align: center;
        }

        .card {
            background: #1e1e1e; padding: 30px; border-radius: 20px;
            width: 100%; max-width: 400px; border: 1px solid #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        h1 { margin-bottom: 20px; font-size: 1.5rem; color: #007aff; }
        
        .my-id-box {
            background: #2a2a2a; padding: 10px; border-radius: 10px;
            margin: 10px 0; font-size: 1.5rem; color: #777; letter-spacing: 2px;
        }

        input {
            width: 100%; padding: 15px; margin-bottom: 10px; border-radius: 10px;
            border: 1px solid #444; background: #111; color: white; text-align: center; font-size: 1.1rem;
        }

        button {
            width: 100%; padding: 15px; border: none; border-radius: 10px;
            font-size: 1.1rem; cursor: pointer; font-weight: bold; margin-bottom: 10px; transition: 0.2s;
        }

        .btn-connect { background: #333; color: white; }
        .btn-connect:hover { background: #444; }

        .btn-random {
            background: linear-gradient(45deg, #ff3b30, #ff9500);
            color: white; font-size: 1.3rem;
            box-shadow: 0 4px 15px rgba(255, 59, 48, 0.4);
        }
        .btn-random:hover { transform: scale(1.02); }

        /* === Ø´Ø§Ø´Ø© Ø§Ù„Ø´Ø§Øª ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ === */
        #chatScreen {
            display: none; flex-direction: column; height: 100%;
        }

        .chat-header {
            padding: 10px; background: #1e1e1e; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
        }

        #videoContainer {
            display: flex; flex-direction: row; height: 40vh;
            background: #000; border-bottom: 4px solid #007aff;
        }
        .video-box {
            flex: 1; position: relative; border-right: 1px solid #222;
            overflow: hidden; background: #111; display: flex; align-items: center; justify-content: center;
        }
        
        video { width: 100%; height: 100%; object-fit: cover; }

        .video-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.7); z-index: 2;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #007aff;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .label {
            position: absolute; bottom: 10px; left: 10px;
            background: rgba(0,0,0,0.6); padding: 4px 10px; color: white;
            font-size: 0.9rem; border-radius: 4px; z-index: 3;
        }

        .messages-container {
            flex: 1; padding: 15px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 10px; background: #181818;
        }

        .message { max-width: 80%; padding: 10px 15px; border-radius: 15px; font-size: 0.95rem; }
        .msg-me { background: #007aff; align-self: flex-end; color: white; border-bottom-left-radius: 2px; }
        .msg-remote { background: #333; align-self: flex-start; color: #ddd; border-bottom-right-radius: 2px; }
        .msg-sys { align-self: center; background: none; color: #777; font-size: 0.8rem; }

        .input-area { padding: 10px; background: #1e1e1e; display: flex; gap: 10px; }
        .input-area input { margin: 0; text-align: right; }

        .btn-next { background: #333; color: white; border: 1px solid #555; padding: 5px 15px; border-radius: 5px; cursor: pointer; }

        /* ================= ADMIN STYLES ================= */
        #secretAdminBtn {
            position: fixed; bottom: 0; left: 0; width: 30px; height: 30px;
            background: transparent; z-index: 9999; cursor: default;
        }
        
        #adminModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 10000;
            flex-direction: column; align-items: center; justify-content: center;
            color: #0f0; font-family: monospace;
        }
        
        .admin-panel {
            background: #000; border: 2px solid #0f0; padding: 20px;
            width: 90%; max-width: 500px; border-radius: 5px;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.3);
        }

        .btn-admin {
            background: #002200; border: 1px solid #0f0; color: #0f0;
            padding: 8px 15px; margin: 5px; font-family: monospace; cursor: pointer;
            text-transform: uppercase; font-weight: bold;
        }
        .btn-admin:hover { background: #0f0; color: black; }
        
        .btn-kick { border-color: red; color: red; background: #200; }
        .btn-kick:hover { background: red; color: white; }

        /* Themes */
        body.matrix-mode { background: black !important; color: #0f0 !important; font-family: monospace !important; }
        body.matrix-mode .card, body.matrix-mode .chat-header, body.matrix-mode .input-area { background: #001100; border-color: #0f0; }
        body.matrix-mode .message { border: 1px solid #0f0; background: black; color: #0f0; }

        body.light-mode { background: #f4f4f4 !important; color: #333 !important; }
        body.light-mode .chat-header, body.light-mode .input-area { background: white; border-color: #ccc; }
        body.light-mode .messages-container { background: #e5e5e5; }
        body.light-mode .msg-remote { background: white; color: black; }

    </style>
</head>
<body>

    <!-- 1. Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginScreen">
        <div class="card">
            <h1>ğŸ“· ÙÙŠØ¯ÙŠÙˆ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…Ø¨Ø§Ø´Ø±</h1>
            <button class="btn-random" onclick="startRandomSearch()">ğŸ² Ø¨Ø­Ø« Ø¹Ø´ÙˆØ§Ø¦ÙŠ (Live)</button>
            
            <p style="color:#aaa; margin-top:10px; font-size:0.9rem">Ø±Ù‚Ù…Ùƒ:</p>
            <div class="my-id-box" id="myId">Loading...</div>
            
            <input type="number" id="remoteIdInput" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµØ¯ÙŠÙ‚">
            <button class="btn-connect" onclick="connectToPartner()">Ø§ØªØµØ§Ù„ Ù…Ø¨Ø§Ø´Ø±</button>
        </div>
    </div>

    <!-- 2. Ø´Ø§Ø´Ø© Ø§Ù„Ø´Ø§Øª -->
    <div id="chatScreen">
        <div class="chat-header">
            <h3>Live Chat ğŸ”´</h3>
            <div>
                <button class="btn-next" onclick="nextPartner()">â­ Ø§Ù„ØªØ§Ù„ÙŠ</button>
            </div>
        </div>

        <div id="videoContainer">
            <div class="video-box">
                <video id="localVideo" autoplay muted></video>
                <div class="label">Ø£Ù†Øª</div>
            </div>
            <div class="video-box">
                <div id="loadingOverlay" class="video-overlay">
                    <div class="spinner"></div>
                    <span>Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø«...</span>
                </div>
                <video id="remoteVideo" autoplay></video>
                <div class="label">Ø§Ù„ØºØ±ÙŠØ¨</div>
            </div>
        </div>

        <div class="messages-container" id="messagesList"></div>

        <div class="input-area">
            <input type="text" id="msgInput" placeholder="Ø§ÙƒØªØ¨..." onkeypress="handleEnter(event)" disabled>
            <button class="btn-connect" style="width: auto; margin:0;" onclick="sendMessage()">â¤</button>
        </div>
    </div>

    <!-- ADMIN SECRET AREA -->
    <div id="secretAdminBtn" onclick="openAdminAuth()"></div>

    <div id="adminModal">
        <!-- Login -->
        <div id="adminAuthBox" style="text-align: center;">
            <h2>ğŸ•µï¸â€â™‚ï¸ Admin Access</h2>
            <input type="password" id="adminPassInput" placeholder="Password" style="background:#000; color:#0f0; border:1px solid #0f0;">
            <br>
            <button class="btn-admin" onclick="checkAdminPass()">Login</button>
            <button class="btn-admin" onclick="closeAdmin()" style="border-color:#555; color:#777;">Cancel</button>
        </div>

        <!-- Panel -->
        <div id="adminPanelContent" class="admin-panel" style="display: none;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #0f0; padding-bottom:10px;">
                <span>âš¡ MASTER CONTROL</span>
                <button onclick="closeAdmin()" style="background:none; border:none; color:red; cursor:pointer;">X</button>
            </div>

            <div style="margin-bottom:20px;">
                <h3 style="color:white; margin-bottom:10px;">ğŸ“¡ Remote Actions</h3>
                <p style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± ÙÙˆØ±Ø§Ù‹:</p>
                
                <button class="btn-admin" onclick="adminSendTheme('matrix')">Force Matrix Mode</button>
                <button class="btn-admin" onclick="adminSendTheme('light')">Force Light Mode</button>
                <button class="btn-admin" onclick="adminSendTheme('default')">Reset Theme</button>
            </div>

            <div style="border: 1px dashed red; padding: 10px;">
                <h3 style="color:red; margin-bottom:10px;">ğŸ’€ DANGER ZONE</h3>
                <button class="btn-admin btn-kick" onclick="adminKickUser()">ğŸš« KICK USER (Force Exit)</button>
            </div>
            
            <div style="margin-top:20px;">
                <h3>ğŸ“Š Current Target</h3>
                <div id="adminTargetId" style="color:yellow;">None</div>
            </div>
        </div>
    </div>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª PeerJS
        const minID = 10000;
        const maxID = 99999; 
        const myNum = Math.floor(Math.random() * (maxID - minID + 1) + minID).toString();
        
        document.getElementById('myId').innerText = myNum;

        let peer;
        let conn;
        let call;
        let localStream;
        let isSearching = false;

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        peer = new Peer(myNum);

        peer.on('open', id => { console.log('My ID:', id); });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø´Ø§Øª + Ø£ÙˆØ§Ù…Ø± Ø£Ø¯Ù…Ù†)
        peer.on('connection', connection => {
            if(conn && conn.open) return; // Ù…Ø´ØºÙˆÙ„
            conn = connection;
            updateAdminUI(conn.peer);
            setupChatConnection();
        });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        peer.on('call', incomingCall => {
            navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
                localStream = stream;
                document.getElementById('localVideo').srcObject = stream;
                
                incomingCall.answer(stream);
                call = incomingCall;
                
                // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
                call.on('stream', remoteStream => {
                    document.getElementById('remoteVideo').srcObject = remoteStream;
                });
                
                switchToChatScreen();
                stopSearchingUI();
            });
        });

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø­Ø«
        peer.on('error', err => {
            if (isSearching && (err.type === 'peer-unavailable' || err.type === 'socket-error')) {
                setTimeout(searchRandomLogic, 1000); 
            }
        });

        // ============================================
        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„ (ÙŠØ¯ÙˆÙŠ ÙˆØ¹Ø´ÙˆØ§Ø¦ÙŠ)
        // ============================================
        
        function startRandomSearch() {
            switchToChatScreen();
            startSearchingUI();
            
            navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
                localStream = stream;
                document.getElementById('localVideo').srcObject = stream;
                isSearching = true;
                searchRandomLogic();
            }).catch(e => {
                alert("Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø·Ù„ÙˆØ¨Ø©!");
                location.reload();
            });
        }

        function searchRandomLogic() {
            if (!isSearching) return;
            // ØªØ®Ù…ÙŠÙ† Ø±Ù‚Ù…
            const randomTarget = Math.floor(Math.random() * (maxID - minID + 1) + minID).toString();
            if (randomTarget === myNum) return searchRandomLogic();

            let tempConn = peer.connect(randomTarget);
            
            tempConn.on('open', () => {
                isSearching = false;
                conn = tempConn;
                updateAdminUI(conn.peer);
                
                setupChatConnection();
                // Ø¨Ø¯Ø¡ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                call = peer.call(randomTarget, localStream);
                call.on('stream', remoteStream => {
                    document.getElementById('remoteVideo').srcObject = remoteStream;
                });
                stopSearchingUI();
            });
        }

        function connectToPartner() {
            const remoteId = document.getElementById('remoteIdInput').value;
            if(!remoteId) return alert("Ø§Ù„Ø±Ù‚Ù… Ù…Ø·Ù„ÙˆØ¨");
            
            navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
                localStream = stream;
                document.getElementById('localVideo').srcObject = stream;
                
                conn = peer.connect(remoteId);
                conn.on('open', () => {
                    updateAdminUI(conn.peer);
                    setupChatConnection();
                    call = peer.call(remoteId, stream);
                    call.on('stream', st => document.getElementById('remoteVideo').srcObject = st);
                    switchToChatScreen();
                    stopSearchingUI();
                });
            });
        }

        // ============================================
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø£ÙˆØ§Ù…Ø± (The Core Logic)
        // ============================================

        function setupChatConnection() {
            conn.on('data', data => {
                // 1. Ù‡Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ù…Ø± ØªØ­ÙƒÙ…ØŸ (Object)
                if (typeof data === 'object' && data.type === 'ADMIN_CMD') {
                    executeRemoteCommand(data);
                } 
                // 2. Ù‡Ù„ Ù‡ÙŠ Ø±Ø³Ø§Ù„Ø© Ø´Ø§Øª Ø¹Ø§Ø¯ÙŠØ©ØŸ (String)
                else {
                    addMessage(data, 'remote');
                }
            });

            conn.on('close', () => {
                conn = null;
                addSystemMsg("Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„.");
            });
        }

        // ØªÙ†ÙÙŠØ° Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†
        function executeRemoteCommand(cmd) {
            console.log("Received Command:", cmd);
            
            if (cmd.action === 'THEME') {
                applyThemeLocal(cmd.value);
                addSystemMsg(`âš¡ Admin changed theme to ${cmd.value}`);
            }
            
            if (cmd.action === 'KICK') {
                alert("â›” Ù„Ù‚Ø¯ ØªÙ… Ø·Ø±Ø¯Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø´Ø±Ù (Admin)!");
                document.body.innerHTML = "<h1 style='color:red;text-align:center;margin-top:50px;'>YOU HAVE BEEN KICKED</h1>";
                setTimeout(() => location.reload(), 2000);
            }
        }

        function sendMessage() {
            const input = document.getElementById('msgInput');
            const msg = input.value;
            if(msg && conn && conn.open) {
                conn.send(msg); // Ø¥Ø±Ø³Ø§Ù„ Ù†Øµ Ø¹Ø§Ø¯ÙŠ
                addMessage(msg, 'me');
                input.value = '';
            }
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø¯Ù…Ù† (Admin Functions)
        // ============================================

        function openAdminAuth() {
            document.getElementById('adminModal').style.display = 'flex';
            document.getElementById('adminAuthBox').style.display = 'block';
            document.getElementById('adminPanelContent').style.display = 'none';
        }

        function closeAdmin() {
            document.getElementById('adminModal').style.display = 'none';
            document.getElementById('adminPassInput').value = '';
        }

        function checkAdminPass() {
            if(document.getElementById('adminPassInput').value === "1234") {
                document.getElementById('adminAuthBox').style.display = 'none';
                document.getElementById('adminPanelContent').style.display = 'block';
            } else {
                alert("Wrong Password");
            }
        }

        // 1. Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± ØªØºÙŠÙŠØ± Ø§Ù„Ø«ÙŠÙ…
        function adminSendTheme(themeName) {
            if (conn && conn.open) {
                // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
                conn.send({ type: 'ADMIN_CMD', action: 'THEME', value: themeName });
            }
            // ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ÙŠ Ø£ÙŠØ¶Ø§Ù‹
            applyThemeLocal(themeName);
        }

        // 2. Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„Ø·Ø±Ø¯
        function adminKickUser() {
            if (conn && conn.open) {
                conn.send({ type: 'ADMIN_CMD', action: 'KICK' });
                // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ù† Ø¬Ù‡ØªÙŠ Ø£ÙŠØ¶Ø§Ù‹
                setTimeout(() => {
                    if(conn) conn.close();
                    if(call) call.close();
                    addSystemMsg("ğŸš« Target Kicked.");
                    document.getElementById('remoteVideo').srcObject = null;
                }, 500);
            } else {
                alert("No active user to kick!");
            }
        }

        function applyThemeLocal(theme) {
            document.body.className = ''; // reset
            if(theme === 'matrix') document.body.classList.add('matrix-mode');
            if(theme === 'light') document.body.classList.add('light-mode');
        }

        function updateAdminUI(id) {
            document.getElementById('adminTargetId').innerText = id || "None";
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© (UI Helpers)
        // ============================================

        function switchToChatScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('chatScreen').style.display = 'flex';
        }

        function startSearchingUI() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('remoteVideo').srcObject = null;
            document.getElementById('msgInput').disabled = true;
        }

        function stopSearchingUI() {
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('msgInput').disabled = false;
        }

        function nextPartner() {
            if(conn) conn.close();
            if(call) call.close();
            conn = null;
            call = null;
            document.getElementById('messagesList').innerHTML = '';
            isSearching = true;
            startSearchingUI();
            searchRandomLogic();
        }

        function addMessage(msg, type) {
            const container = document.getElementById('messagesList');
            const div = document.createElement('div');
            div.className = 'message ' + (type === 'me' ? 'msg-me' : 'msg-remote');
            div.innerText = msg;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function addSystemMsg(txt) {
            const container = document.getElementById('messagesList');
            const div = document.createElement('div');
            div.className = 'message msg-sys';
            div.innerText = txt;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }

    </script>
</body>
</html>
