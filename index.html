<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø´Ø§Øª ÙÙŠØ¯ÙŠÙˆ Ø¹Ø´ÙˆØ§Ø¦ÙŠ + Admin</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        
        body { 
            background: #111; 
            color: white; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            transition: 0.3s background;
        }

        /* === Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ === */
        #loginScreen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }

        .card {
            background: #1e1e1e;
            padding: 30px;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid #333;
        }

        h1 { margin-bottom: 20px; font-size: 1.5rem; color: #007aff; }
        
        .my-id-box {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 1.5rem;
            color: #777;
            letter-spacing: 2px;
        }

        input {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border: 1px solid #444;
            background: #111;
            color: white;
            text-align: center;
            font-size: 1.1rem;
        }

        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 10px;
            transition: 0.2s;
        }

        .btn-connect { background: #333; color: white; }
        .btn-connect:hover { background: #444; }

        .btn-random {
            background: linear-gradient(45deg, #ff3b30, #ff9500);
            color: white;
            font-size: 1.3rem;
            box-shadow: 0 4px 15px rgba(255, 59, 48, 0.4);
        }
        .btn-random:hover { transform: scale(1.02); }

        /* === Ø´Ø§Ø´Ø© Ø§Ù„Ø´Ø§Øª ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ === */
        #chatScreen {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .chat-header {
            padding: 10px;
            background: #1e1e1e;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #videoContainer {
            display: flex;
            flex-direction: row;
            height: 40vh;
            background: #000;
            border-bottom: 4px solid #007aff;
        }
        .video-box {
            flex: 1;
            position: relative;
            border-right: 1px solid #222;
            overflow: hidden;
            background: #111;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .video-box:last-child { border-right: none; }
        
        video { width: 100%; height: 100%; object-fit: cover; }

        .video-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.7); z-index: 2;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #007aff;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .label {
            position: absolute; bottom: 10px; left: 10px;
            background: rgba(0,0,0,0.6); padding: 4px 10px; color: white;
            font-size: 0.9rem; border-radius: 4px; z-index: 3;
        }

        .messages-container {
            flex: 1; padding: 15px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 10px; background: #181818;
        }

        .message { max-width: 80%; padding: 10px 15px; border-radius: 15px; font-size: 0.95rem; }
        .msg-me { background: #007aff; align-self: flex-end; color: white; border-bottom-left-radius: 2px; }
        .msg-remote { background: #333; align-self: flex-start; color: #ddd; border-bottom-right-radius: 2px; }

        .input-area { padding: 10px; background: #1e1e1e; display: flex; gap: 10px; }
        .input-area input { margin: 0; text-align: right; }

        .btn-next { background: #333; color: white; border: 1px solid #555; padding: 5px 15px; border-radius: 5px; cursor: pointer; }

        /* ========================================= */
        /* ============== ADMIN STYLES ============= */
        /* ========================================= */
        
        /* Ø§Ù„Ø²Ø± Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹ */
        #secretAdminBtn {
            position: fixed;
            bottom: 5px;
            left: 5px;
            width: 15px;
            height: 15px;
            background: red;
            border-radius: 50%;
            opacity: 0.1; /* Ø´ÙØ§Ù ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ */
            cursor: default;
            z-index: 9999;
        }
        #secretAdminBtn:hover { opacity: 0.5; cursor: pointer; }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£Ø¯Ù…Ù† */
        #adminModal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #0f0;
            font-family: monospace;
        }
        
        .admin-panel {
            background: #000;
            border: 2px solid #0f0;
            padding: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 5px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        }

        .admin-header { font-size: 1.5rem; border-bottom: 1px solid #0f0; margin-bottom: 15px; padding-bottom: 10px; display: flex; justify-content: space-between; }
        
        .admin-section { margin-bottom: 20px; border: 1px dashed #333; padding: 10px; }
        .admin-section h3 { color: white; margin-bottom: 10px; font-size: 1rem; }
        
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; color: #aaa; }
        .stat-val { color: #fff; font-weight: bold; }

        .btn-admin {
            background: #003300; border: 1px solid #0f0; color: #0f0;
            padding: 5px 10px; margin: 5px; font-family: monospace; cursor: pointer; width: auto; display: inline-block;
        }
        .btn-admin:hover { background: #0f0; color: black; }
        .btn-kick { border-color: red; color: red; background: #300; }
        .btn-kick:hover { background: red; color: white; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8rem; }
        th, td { border: 1px solid #333; padding: 5px; text-align: left; color: #ccc; }
        th { color: #0f0; }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù…Ø§ØªØ±ÙŠÙƒØ³ */
        body.matrix-mode { background: black !important; color: #0f0 !important; }
        body.matrix-mode .card, body.matrix-mode .chat-header, body.matrix-mode .input-area { background: #001100; border-color: #0f0; }
        body.matrix-mode button { border: 1px solid #0f0; }
    </style>
</head>
<body>

    <!-- 1. Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginScreen">
        <div class="card">
            <h1>ğŸ“· Ø´Ø§Øª ÙÙŠØ¯ÙŠÙˆ Ø¹Ø´ÙˆØ§Ø¦ÙŠ</h1>
            <button class="btn-random" onclick="startRandomSearch()">ğŸ² Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©</button>
            <div style="margin: 20px 0; border-top: 1px solid #333; position: relative;">
                <span style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #1e1e1e; padding: 0 10px; color: #666; font-size: 0.8rem;">Ø£Ùˆ ÙŠØ¯ÙˆÙŠØ§Ù‹</span>
            </div>
            <p style="color:#aaa; font-size:0.9rem">Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø®Ø§Øµ:</p>
            <div class="my-id-box" id="myId">...</div>
            <input type="number" id="remoteIdInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… ØµØ¯ÙŠÙ‚ Ù„Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±">
            <button class="btn-connect" onclick="connectToPartner()">Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ù… Ù…Ø­Ø¯Ø¯</button>
        </div>
    </div>

    <!-- 2. Ø´Ø§Ø´Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù„Ø´Ø§Øª -->
    <div id="chatScreen">
        <div class="chat-header">
            <h3>OME Chat ğŸ”´</h3>
            <div>
                <button class="btn-next" onclick="nextPartner()">â­ Ø§Ù„ØªØ§Ù„ÙŠ</button>
                <button onclick="location.reload()" style="background:none; border:none; color:red; cursor:pointer; margin-right:10px;">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <div id="videoContainer">
            <div class="video-box">
                <video id="localVideo" autoplay muted></video>
                <div class="label">Ø£Ù†Øª</div>
            </div>
            <div class="video-box">
                <div id="loadingOverlay" class="video-overlay">
                    <div class="spinner"></div>
                    <span>Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø«...</span>
                </div>
                <video id="remoteVideo" autoplay></video>
                <div class="label">Ø§Ù„Ø´Ø±ÙŠÙƒ Ø§Ù„ØºØ±ÙŠØ¨</div>
            </div>
        </div>

        <div class="messages-container" id="messagesList">
            <div style="text-align: center; color: #555; margin-top: 20px; font-size: 0.9rem;">
                Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø®Øµ...
            </div>
        </div>

        <div class="input-area">
            <input type="text" id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." onkeypress="handleEnter(event)" disabled>
            <button class="btn-connect" style="width: auto; margin:0;" onclick="sendMessage()">â¤</button>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- ============== ADMIN PANEL ============== -->
    <!-- ========================================= -->
    
    <!-- Ø§Ù„Ø²Ø± Ø§Ù„Ø³Ø±ÙŠ -->
    <div id="secretAdminBtn" onclick="openAdminAuth()"></div>

    <!-- Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø£Ø¯Ù…Ù† -->
    <div id="adminModal">
        <div id="adminAuthBox" style="text-align: center;">
            <h2 style="margin-bottom: 20px;">ğŸ”’ Security Check</h2>
            <input type="password" id="adminPassInput" placeholder="Enter Password" style="background: #000; color: #0f0; border: 1px solid #0f0;">
            <br>
            <button class="btn-admin" onclick="checkAdminPass()">Access</button>
            <button class="btn-admin" onclick="closeAdmin()" style="border-color: #555; color: #777;">Cancel</button>
        </div>

        <div id="adminPanelContent" class="admin-panel" style="display: none;">
            <div class="admin-header">
                <span>âš¡ Admin Control Panel</span>
                <button onclick="closeAdmin()" style="background:none; border:none; color:red; cursor:pointer;">X</button>
            </div>

            <!-- Ù…ÙŠØ²Ø© 1: Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
            <div class="admin-section">
                <h3>ğŸ“Š Connection Status</h3>
                <div class="stat-row"><span>My ID:</span> <span id="admMyId" class="stat-val">---</span></div>
                <div class="stat-row"><span>Connected To:</span> <span id="admRemoteId" class="stat-val" style="color: yellow;">None</span></div>
                <div class="stat-row"><span>Status:</span> <span id="admStatus" class="stat-val">Idle</span></div>
            </div>

            <!-- Ù…ÙŠØ²Ø© 2: Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØµÙØ­Ø© (Themes) -->
            <div class="admin-section">
                <h3>ğŸ¨ UI Customization</h3>
                <button class="btn-admin" onclick="setTheme('default')">Default Dark</button>
                <button class="btn-admin" onclick="setTheme('matrix')">Matrix Hacker</button>
                <button class="btn-admin" onclick="setTheme('light')">Light Mode</button>
            </div>

            <!-- Ù…ÙŠØ²Ø© 3: Ø§Ù„Ø·Ø±Ø¯ (Kick) -->
            <div class="admin-section">
                <h3>ğŸš« User Actions</h3>
                <p style="color: #777; font-size: 0.8rem; margin-bottom: 5px;">Force disconnect current user:</p>
                <button class="btn-admin btn-kick" onclick="adminKickUser()">âš ï¸ KICK USER NOW</button>
            </div>

            <!-- Ù…ÙŠØ²Ø© 4: Ø³Ø¬Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© -->
            <div class="admin-section">
                <h3>ğŸ’¾ Saved Logs (History)</h3>
                <button class="btn-admin" onclick="clearLogs()" style="font-size: 0.7rem;">Clear History</button>
                <table id="logsTable">
                    <thead><tr><th>Time</th><th>User ID</th><th>Type</th></tr></thead>
                    <tbody id="logsBody">
                        <!-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const minID = 1000;
        const maxID = 5000; 
        const myNum = Math.floor(Math.random() * (maxID - minID + 1) + minID).toString();
        
        document.getElementById('myId').innerText = myNum;
        document.getElementById('admMyId').innerText = myNum; // Admin Panel

        let peer;
        let conn;
        let call;
        let localStream;
        let isSearching = false;
        let currentRemoteId = null; // Ù„Ø­ÙØ¸ Ù‡ÙˆÙŠØ© Ø§Ù„Ù…ØªØµÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ

        peer = new Peer(myNum);

        peer.on('open', id => { console.log('My ID:', id); });

        peer.on('connection', connection => {
            if(conn && conn.open) return;
            conn = connection;
            currentRemoteId = conn.peer;
            updateAdminStats("Connected (Text)", conn.peer);
            saveLog(conn.peer, "Incoming Text");
            setupChatConnection();
        });

        peer.on('call', incomingCall => {
            navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
                localStream = stream;
                document.getElementById('localVideo').srcObject = stream;
                
                incomingCall.answer(stream);
                call = incomingCall;
                currentRemoteId = call.peer;
                
                updateAdminStats("Connected (Video)", call.peer);
                saveLog(call.peer, "Incoming Video");

                setupVideoCall();
                switchToChatScreen();
                stopSearchingUI();
            });
        });

        peer.on('error', err => {
            if (isSearching && (err.type === 'peer-unavailable' || err.type === 'socket-error')) {
                setTimeout(searchRandomLogic, 500); 
            }
        });

        function startRandomSearch() {
            switchToChatScreen();
            startSearchingUI();
            updateAdminStats("Searching...", "---");
            
            navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
                localStream = stream;
                document.getElementById('localVideo').srcObject = stream;
                isSearching = true;
                searchRandomLogic();
            }).catch(e => {
                alert("ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§");
                location.reload();
            });
        }

        function searchRandomLogic() {
            if (!isSearching) return;
            const randomTarget = Math.floor(Math.random() * (maxID - minID + 1) + minID).toString();
            if (randomTarget === myNum) return searchRandomLogic();

            let tempConn = peer.connect(randomTarget);
            tempConn.on('open', () => {
                isSearching = false;
                conn = tempConn;
                currentRemoteId = randomTarget;
                
                updateAdminStats("Connected (Initiator)", randomTarget);
                saveLog(randomTarget, "Outgoing Call");

                setupChatConnection();
                call = peer.call(randomTarget, localStream);
                setupVideoCall();
                stopSearchingUI();
            });
        }

        function connectToPartner() {
            const remoteId = document.getElementById('remoteIdInput').value;
            if(!remoteId) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù‚Ù…");
            navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
                localStream = stream;
                document.getElementById('localVideo').srcObject = stream;
                conn = peer.connect(remoteId);
                conn.on('open', () => {
                    currentRemoteId = remoteId;
                    updateAdminStats("Connected (Manual)", remoteId);
                    saveLog(remoteId, "Manual Call");
                    setupChatConnection();
                    call = peer.call(remoteId, stream);
                    setupVideoCall();
                    switchToChatScreen();
                    stopSearchingUI();
                });
            });
        }

        function switchToChatScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('chatScreen').style.display = 'flex';
        }

        function startSearchingUI() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('remoteVideo').srcObject = null;
            document.getElementById('msgInput').disabled = true;
        }

        function stopSearchingUI() {
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('msgInput').disabled = false;
        }

        function nextPartner() {
            if(conn) conn.close();
            if(call) call.close();
            conn = null;
            call = null;
            currentRemoteId = null;
            updateAdminStats("Skipped", "None");
            document.getElementById('messagesList').innerHTML = '';
            isSearching = true;
            startSearchingUI();
            searchRandomLogic();
        }

        function setupChatConnection() {
            conn.on('data', data => addMessage(data, 'remote'));
            conn.on('close', () => {
                conn = null;
                updateAdminStats("Disconnected", "None");
            });
        }

        function setupVideoCall() {
            call.on('stream', remoteStream => {
                document.getElementById('remoteVideo').srcObject = remoteStream;
            });
            call.on('close', () => {
                document.getElementById('remoteVideo').srcObject = null;
            });
        }

        function sendMessage() {
            const input = document.getElementById('msgInput');
            const msg = input.value;
            if(msg && conn && conn.open) {
                conn.send(msg);
                addMessage(msg, 'me');
                input.value = '';
            }
        }

        function addMessage(msg, type) {
            const container = document.getElementById('messagesList');
            const div = document.createElement('div');
            div.className = 'message ' + (type === 'me' ? 'msg-me' : 'msg-remote');
            div.innerText = msg;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }

        /* ========================================= */
        /* ============== ADMIN LOGIC ============== */
        /* ========================================= */

        // 1. Ø§Ù„ÙØªØ­ ÙˆØ§Ù„ØªØ­Ù‚Ù‚
        function openAdminAuth() {
            document.getElementById('adminModal').style.display = 'flex';
            document.getElementById('adminAuthBox').style.display = 'block';
            document.getElementById('adminPanelContent').style.display = 'none';
        }

        function closeAdmin() {
            document.getElementById('adminModal').style.display = 'none';
            document.getElementById('adminPassInput').value = '';
        }

        function checkAdminPass() {
            const pass = document.getElementById('adminPassInput').value;
            if(pass === "1234") { // ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
                document.getElementById('adminAuthBox').style.display = 'none';
                document.getElementById('adminPanelContent').style.display = 'block';
                renderLogs();
            } else {
                alert("Wrong Password!");
            }
        }

        // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
        function updateAdminStats(status, remoteId) {
            document.getElementById('admStatus').innerText = status;
            document.getElementById('admRemoteId').innerText = remoteId;
        }

        // 3. ØªØºÙŠÙŠØ± Ø§Ù„Ø«ÙŠÙ…
        function setTheme(theme) {
            document.body.className = '';
            if(theme === 'matrix') {
                document.body.classList.add('matrix-mode');
            } else if (theme === 'light') {
                document.body.style.background = '#f0f0f0';
                document.body.style.color = '#333';
            } else {
                document.body.style.background = '#111';
                document.body.style.color = 'white';
            }
        }

        // 4. Ù…ÙŠØ²Ø© Ø§Ù„Ø·Ø±Ø¯ (Kick)
        function adminKickUser() {
            if(conn) {
                conn.send("ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„.");
                conn.close();
            }
            if(call) {
                call.close();
            }
            alert("User Kicked!");
            updateAdminStats("Kicked", "None");
            document.getElementById('remoteVideo').srcObject = null;
        }

        // 5. Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Logs)
        function saveLog(id, type) {
            let logs = JSON.parse(localStorage.getItem('chatLogs') || "[]");
            const time = new Date().toLocaleTimeString();
            logs.push({ time, id, type });
            localStorage.setItem('chatLogs', JSON.stringify(logs));
            if(document.getElementById('adminModal').style.display === 'flex') {
                renderLogs();
            }
        }

        function renderLogs() {
            const logs = JSON.parse(localStorage.getItem('chatLogs') || "[]");
            const tbody = document.getElementById('logsBody');
            tbody.innerHTML = '';
            logs.reverse().forEach(log => { // Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
                let row = `<tr><td>${log.time}</td><td>${log.id}</td><td>${log.type}</td></tr>`;
                tbody.innerHTML += row;
            });
        }

        function clearLogs() {
            if(confirm("Delete all history?")) {
                localStorage.removeItem('chatLogs');
                renderLogs();
            }
        }

    </script>
</body>
</html>
