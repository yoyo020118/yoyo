<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø´Ø§Øª Ø³Ø±ÙŠ ÙÙˆØ±ÙŠ + ÙÙŠØ¯ÙŠÙˆ</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        
        body { 
            background: #111; 
            color: white; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
        }

        /* === Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ === */
        #loginScreen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }

        .card {
            background: #1e1e1e;
            padding: 30px;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid #333;
        }

        h1 { margin-bottom: 20px; font-size: 1.5rem; color: #007aff; }
        
        .my-id-box {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 2rem;
            font-weight: bold;
            color: #00ff88;
            letter-spacing: 3px;
            cursor: pointer;
        }

        input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            border: 1px solid #444;
            background: #111;
            color: white;
            text-align: center;
            font-size: 1.1rem;
        }

        button.btn-connect {
            width: 100%;
            padding: 15px;
            background: #007aff;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            font-weight: bold;
        }

        /* === Ø´Ø§Ø´Ø© Ø§Ù„Ø´Ø§Øª === */
        #chatScreen {
            display: none; /* Ù…Ø®ÙÙŠ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
            flex-direction: column;
            height: 100%;
        }

        .chat-header {
            padding: 15px;
            background: #1e1e1e;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-dot { color: #00ff88; font-size: 0.8rem; }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 75%;
            padding: 12px 18px;
            border-radius: 15px;
            font-size: 1rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .msg-me {
            background: #007aff;
            color: white;
            align-self: flex-end;
            border-bottom-left-radius: 2px;
        }

        .msg-remote {
            background: #333;
            color: #ddd;
            align-self: flex-start;
            border-bottom-right-radius: 2px;
        }

        .input-area {
            padding: 15px;
            background: #1e1e1e;
            display: flex;
            gap: 10px;
        }

        .input-area input { margin: 0; text-align: right; }
        .btn-send { background: #007aff; color: white; border: none; padding: 0 20px; border-radius: 10px; cursor: pointer; font-size: 1.2rem; }

        /* === Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ù…Ø«Ù„ OME TV) === */
        #videoContainer {
            display: none; /* ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± */
            flex-direction: row;
            height: 200px;
            background: #000;
            border-bottom: 2px solid #007aff;
        }
        .video-box {
            flex: 1;
            position: relative;
            border: 1px solid #333;
            overflow: hidden;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .label {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0,0,0,0.6);
            padding: 2px 8px;
            font-size: 0.8rem;
            border-radius: 4px;
        }
        .btn-video-start {
            background: #ff3b30;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            font-weight: bold;
        }

    </style>
</head>
<body>

    <!-- 1. Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø±Ø¨Ø· -->
    <div id="loginScreen">
        <div class="card">
            <h1>ğŸ’¬ Ø´Ø§Øª ÙÙˆØ±ÙŠ</h1>
            <p style="color:#aaa">Ø£Ø¹Ø· Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù„ØµØ¯ÙŠÙ‚Ùƒ:</p>
            <div class="my-id-box" id="myId">...</div>
            
            <hr style="border-color: #333; margin: 20px 0;">

            <p style="color:#aaa; margin-bottom: 10px;">Ø£Ùˆ Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… ØµØ¯ÙŠÙ‚Ùƒ Ù‡Ù†Ø§:</p>
            <input type="number" id="remoteIdInput" placeholder="Ø±Ù‚Ù… Ø§Ù„ØµØ¯ÙŠÙ‚">
            <button class="btn-connect" onclick="connectToPartner()">ğŸ”— Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
        </div>
    </div>

    <!-- 2. Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (ØªØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„) -->
    <div id="chatScreen">
        <div class="chat-header">
            <div style="display:flex; align-items:center;">
                <h3>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ğŸ”’</h3>
                <!-- Ø²Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
                <button class="btn-video-start" onclick="startOmeVideo()">ÙÙŠØ¯ÙŠÙˆ ğŸ“¹</button>
            </div>
            <div>
                <span class="status-dot">â— Ù…ØªØµÙ„</span>
                <button onclick="location.reload()" style="background:none; border:none; color:red; cursor:pointer; margin-right:10px;">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ù…Ø®ÙÙŠØ© Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ù„Ø¶ØºØ·) -->
        <div id="videoContainer">
            <div class="video-box">
                <video id="localVideo" autoplay muted></video>
                <div class="label">Ø£Ù†Øª</div>
            </div>
            <div class="video-box">
                <video id="remoteVideo" autoplay></video>
                <div class="label">Ø§Ù„Ø´Ø±ÙŠÙƒ</div>
            </div>
        </div>

        <div class="messages-container" id="messagesList">
            <div style="text-align: center; color: #555; margin-top: 20px; font-size: 0.9rem;">
                Ø¨Ø¯Ø£Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ø´ÙØ±Ø©. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ÙÙŠØ¯ÙŠÙˆ" Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±.
            </div>
        </div>

        <div class="input-area">
            <input type="text" id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." onkeypress="handleEnter(event)">
            <button class="btn-send" onclick="sendMessage()">â¤</button>
        </div>
    </div>

    <script>
        // ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø¨Ø³ÙŠØ· (Ù…Ø«Ù„ 4821)
        const myNum = Math.floor(1000 + Math.random() * 9000).toString();
        document.getElementById('myId').innerText = myNum;

        let peer;
        let conn;
        let currentCall;

        // Ø¥Ø¹Ø¯Ø§Ø¯ PeerJS
        peer = new Peer(myNum);

        peer.on('open', id => {
            console.log('My ID:', id);
        });

        // 1. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§ØªØµØ§Ù„ Ø´Ø§Øª Ù†ØµÙŠ
        peer.on('connection', connection => {
            conn = connection;
            setupConnection();
        });

        // *** Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ***
        peer.on('call', call => {
            document.getElementById('videoContainer').style.display = 'flex';
            navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
                // Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠ
                document.getElementById('localVideo').srcObject = stream;
                // Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø¨Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠ
                call.answer(stream);
                currentCall = call;

                // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
                call.on('stream', remoteStream => {
                    document.getElementById('remoteVideo').srcObject = remoteStream;
                });
            }).catch(err => {
                alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + err);
            });
        });

        // 2. Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø© Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø´Ø®Øµ Ø¢Ø®Ø±
        function connectToPartner() {
            const remoteId = document.getElementById('remoteIdInput').value;
            if(!remoteId) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø±Ù‚Ù… Ø§Ù„ØµØ¯ÙŠÙ‚");

            conn = peer.connect(remoteId);
            setupConnection();
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„
        function setupConnection() {
            // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø§Øª
            conn.on('open', () => {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('chatScreen').style.display = 'flex';
            });

            // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
            conn.on('data', data => {
                addMessage(data, 'remote');
            });

            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
            conn.on('close', () => {
                alert("Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±");
                location.reload();
            });
        }

        // *** Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø«Ù„ OME TV ***
        function startOmeVideo() {
            if(!conn) return alert("ÙŠØ¬Ø¨ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨ØµØ¯ÙŠÙ‚ Ø£ÙˆÙ„Ø§Ù‹!");
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            document.getElementById('videoContainer').style.display = 'flex';

            // Ø·Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
                document.getElementById('localVideo').srcObject = stream;
                
                // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± ÙÙŠØ¯ÙŠÙˆ
                const call = peer.call(conn.peer, stream);
                currentCall = call;

                call.on('stream', remoteStream => {
                    document.getElementById('remoteVideo').srcObject = remoteStream;
                });
            }).catch(err => {
                alert("ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + err);
            });
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
        function sendMessage() {
            const input = document.getElementById('msgInput');
            const msg = input.value;
            
            if(msg && conn && conn.open) {
                conn.send(msg); // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØµØ¯ÙŠÙ‚
                addMessage(msg, 'me'); // Ø¹Ø±Ø¶ Ø¹Ù†Ø¯ÙŠ
                input.value = ''; // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚Ù„
            }
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø©
        function addMessage(msg, type) {
            const container = document.getElementById('messagesList');
            const div = document.createElement('div');
            div.className = 'message ' + (type === 'me' ? 'msg-me' : 'msg-remote');
            div.innerText = msg;
            
            container.appendChild(div);
            // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø±Ø¤ÙŠØ© Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©
            container.scrollTop = container.scrollHeight;
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø¹Ù†Ø¯ Ø¶ØºØ· Enter
        function handleEnter(e) {
            if(e.key === 'Enter') sendMessage();
        }
    </script>
</body>
</html>
