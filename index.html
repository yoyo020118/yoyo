<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø´Ø§Øª Ø¹Ø´ÙˆØ§Ø¦ÙŠ OmeTV Style</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        
        body { 
            background: #111; 
            color: white; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
        }

        /* === Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ === */
        #loginScreen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }

        .card {
            background: #1e1e1e;
            padding: 30px;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid #333;
        }

        h1 { margin-bottom: 20px; font-size: 1.5rem; color: #007aff; }
        
        .my-id-box {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 1.5rem;
            color: #777;
            letter-spacing: 2px;
        }

        input {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border: 1px solid #444;
            background: #111;
            color: white;
            text-align: center;
            font-size: 1.1rem;
        }

        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 10px;
            transition: 0.2s;
        }

        .btn-connect { background: #333; color: white; }
        .btn-connect:hover { background: #444; }

        /* Ø²Ø± Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        .btn-random {
            background: linear-gradient(45deg, #ff3b30, #ff9500);
            color: white;
            font-size: 1.3rem;
            box-shadow: 0 4px 15px rgba(255, 59, 48, 0.4);
        }
        .btn-random:hover { transform: scale(1.02); }

        /* === Ø´Ø§Ø´Ø© Ø§Ù„Ø´Ø§Øª ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆ === */
        #chatScreen {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .chat-header {
            padding: 10px;
            background: #1e1e1e;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* === ØªØµÙ…ÙŠÙ… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (OME TV Style) === */
        #videoContainer {
            display: flex;
            flex-direction: row;
            height: 40vh; /* Ù…Ø³Ø§Ø­Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
            background: #000;
            border-bottom: 4px solid #007aff;
        }
        .video-box {
            flex: 1;
            position: relative;
            border-right: 1px solid #222;
            overflow: hidden;
            background: #111;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .video-box:last-child { border-right: none; }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.7);
            z-index: 2;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007aff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.6);
            padding: 4px 10px;
            color: white;
            font-size: 0.9rem;
            border-radius: 4px;
            z-index: 3;
        }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
        .messages-container {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #181818;
        }

        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 0.95rem;
        }
        .msg-me { background: #007aff; align-self: flex-end; color: white; border-bottom-left-radius: 2px; }
        .msg-remote { background: #333; align-self: flex-start; color: #ddd; border-bottom-right-radius: 2px; }

        .input-area {
            padding: 10px;
            background: #1e1e1e;
            display: flex;
            gap: 10px;
        }
        .input-area input { margin: 0; text-align: right; }

        /* Ø²Ø± Ø§Ù„ØªØ§Ù„ÙŠ */
        .btn-next {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn-next:hover { background: #555; }

    </style>
</head>
<body>

    <!-- 1. Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginScreen">
        <div class="card">
            <h1>ğŸ“· Ø´Ø§Øª ÙÙŠØ¯ÙŠÙˆ Ø¹Ø´ÙˆØ§Ø¦ÙŠ</h1>
            
            <!-- Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ -->
            <button class="btn-random" onclick="startRandomSearch()">ğŸ² Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©</button>
            
            <div style="margin: 20px 0; border-top: 1px solid #333; position: relative;">
                <span style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #1e1e1e; padding: 0 10px; color: #666; font-size: 0.8rem;">Ø£Ùˆ ÙŠØ¯ÙˆÙŠØ§Ù‹</span>
            </div>

            <p style="color:#aaa; font-size:0.9rem">Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø®Ø§Øµ:</p>
            <div class="my-id-box" id="myId">...</div>
            <input type="number" id="remoteIdInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… ØµØ¯ÙŠÙ‚ Ù„Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±">
            <button class="btn-connect" onclick="connectToPartner()">Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ù… Ù…Ø­Ø¯Ø¯</button>
        </div>
    </div>

    <!-- 2. Ø´Ø§Ø´Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù„Ø´Ø§Øª -->
    <div id="chatScreen">
        <div class="chat-header">
            <h3>OME Chat ğŸ”´</h3>
            <div>
                <button class="btn-next" onclick="nextPartner()">â­ Ø§Ù„ØªØ§Ù„ÙŠ (Ø¨Ø­Ø«)</button>
                <button onclick="location.reload()" style="background:none; border:none; color:red; cursor:pointer; margin-right:10px;">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ -->
        <div id="videoContainer">
            <!-- ÙÙŠØ¯ÙŠÙˆÙŠ Ø£Ù†Ø§ -->
            <div class="video-box">
                <video id="localVideo" autoplay muted></video>
                <div class="label">Ø£Ù†Øª</div>
            </div>
            <!-- ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØºØ±ÙŠØ¨ -->
            <div class="video-box">
                <div id="loadingOverlay" class="video-overlay">
                    <div class="spinner"></div>
                    <span>Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø´Ø±ÙŠÙƒ...</span>
                </div>
                <video id="remoteVideo" autoplay></video>
                <div class="label">Ø§Ù„Ø´Ø±ÙŠÙƒ Ø§Ù„ØºØ±ÙŠØ¨</div>
            </div>
        </div>

        <!-- Ø§Ù„Ø´Ø§Øª -->
        <div class="messages-container" id="messagesList">
            <div style="text-align: center; color: #555; margin-top: 20px; font-size: 0.9rem;">
                Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø®Øµ...
            </div>
        </div>

        <div class="input-area">
            <input type="text" id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." onkeypress="handleEnter(event)" disabled>
            <button class="btn-connect" style="width: auto; margin:0;" onclick="sendMessage()">â¤</button>
        </div>
    </div>

    <script>
        // Ù„Ø²ÙŠØ§Ø¯Ø© ÙØ±ØµØ© Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø®Øµ ÙÙŠ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØŒ Ù†Ù‚Ù„Ù„ Ø§Ù„Ù…Ø¯Ù‰ ÙÙŠ Ø§Ù„Ø¯ÙŠÙ…Ùˆ
        // ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± 1000 Ùˆ 2000 Ù„Ø£ÙŠ Ø£Ø±Ù‚Ø§Ù…
        const minID = 1000;
        const maxID = 5000; 
        const myNum = Math.floor(Math.random() * (maxID - minID + 1) + minID).toString();
        
        document.getElementById('myId').innerText = myNum;

        let peer;
        let conn; // Ø§ØªØµØ§Ù„ Ø§Ù„Ø¯Ø§ØªØ§
        let call; // Ø§ØªØµØ§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        let localStream;
        let isSearching = false;

        // Ø¥Ø¹Ø¯Ø§Ø¯ PeerJS
        peer = new Peer(myNum);

        peer.on('open', id => { console.log('My ID:', id); });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§ØªØµØ§Ù„ (Ù†ØµÙŠ Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ)
        peer.on('connection', connection => {
            if(conn && conn.open) return; // Ù…Ø´ØºÙˆÙ„
            conn = connection;
            setupChatConnection();
        });

        peer.on('call', incomingCall => {
            // Ø§Ù„Ø±Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ Ø¬Ø§Ø¡ Ø§ØªØµØ§Ù„ ÙÙŠØ¯ÙŠÙˆ
            navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
                localStream = stream;
                document.getElementById('localVideo').srcObject = stream;
                
                incomingCall.answer(stream);
                call = incomingCall;
                setupVideoCall();
                
                // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù„Ø´Ø§Ø´Ø©
                switchToChatScreen();
                stopSearchingUI();
            });
        });

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ (Ù…Ù‡Ù… Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ)
        peer.on('error', err => {
            console.log(err.type);
            if (isSearching && (err.type === 'peer-unavailable' || err.type === 'socket-error')) {
                // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…ØŒ Ø§Ø¨Ø­Ø« Ø¹Ù† Ø±Ù‚Ù… Ø¢Ø®Ø± ÙÙˆØ±Ø§Ù‹
                console.log("Not found, trying next...");
                setTimeout(searchRandomLogic, 500); 
            }
        });

        // --- 1. Ø²Ø± Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ ---
        function startRandomSearch() {
            switchToChatScreen();
            startSearchingUI();
            
            // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙŠ Ø£ÙˆÙ„Ø§Ù‹
            navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
                localStream = stream;
                document.getElementById('localVideo').srcObject = stream;
                // Ø§Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø­Ù„Ù‚Ø© Ø§Ù„Ø¨Ø­Ø«
                isSearching = true;
                searchRandomLogic();
            }).catch(e => {
                alert("ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©");
                location.reload();
            });
        }

        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø­Ø« (ÙŠØ¬Ø±Ø¨ Ø£Ø±Ù‚Ø§Ù… Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø­ØªÙ‰ ÙŠÙ…Ø³Ùƒ Ø®Ø·)
        function searchRandomLogic() {
            if (!isSearching) return;

            // ØªØ®Ù…ÙŠÙ† Ø±Ù‚Ù… Ø¹Ø´ÙˆØ§Ø¦ÙŠ
            const randomTarget = Math.floor(Math.random() * (maxID - minID + 1) + minID).toString();
            
            // Ù„Ø§ ØªØªØµÙ„ Ø¨Ù†ÙØ³Ùƒ
            if (randomTarget === myNum) {
                return searchRandomLogic();
            }

            console.log("Trying to connect to:", randomTarget);

            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
            let tempConn = peer.connect(randomTarget);
            
            // Ø¥Ø°Ø§ ÙØªØ­ Ø§Ù„Ø§ØªØµØ§Ù„ ÙŠØ¹Ù†ÙŠ ÙˆØ¬Ø¯Ù†Ø§ Ø´Ø®Øµ!
            tempConn.on('open', () => {
                isSearching = false;
                conn = tempConn;
                setupChatConnection();
                
                // Ø¨Ø¯Ø¡ Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙˆØ±Ø§Ù‹
                call = peer.call(randomTarget, localStream);
                setupVideoCall();
                stopSearchingUI();
            });

            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ Ù„Ù… ÙŠÙ†Ø¬Ø­ØŒ Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ peer.on('error') ÙˆØ³Ù†Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
        }

        // --- 2. Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ ---
        function connectToPartner() {
            const remoteId = document.getElementById('remoteIdInput').value;
            if(!remoteId) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù‚Ù…");
            
            navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(stream => {
                localStream = stream;
                document.getElementById('localVideo').srcObject = stream;
                
                conn = peer.connect(remoteId);
                conn.on('open', () => {
                    setupChatConnection();
                    call = peer.call(remoteId, stream);
                    setupVideoCall();
                    switchToChatScreen();
                    stopSearchingUI();
                });
            });
        }

        // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
        function switchToChatScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('chatScreen').style.display = 'flex';
        }

        function startSearchingUI() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('remoteVideo').srcObject = null;
            document.getElementById('msgInput').disabled = true;
            addSystemMsg("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø´Ø±ÙŠÙƒ Ø¹Ø´ÙˆØ§Ø¦ÙŠ... ğŸ”");
        }

        function stopSearchingUI() {
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('msgInput').disabled = false;
            addSystemMsg("ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„! ğŸŸ¢");
        }

        function nextPartner() {
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ù„Ø¨Ø­Ø« Ù…Ù† Ø¬Ø¯ÙŠØ¯
            if(conn) conn.close();
            if(call) call.close();
            conn = null;
            call = null;
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø§Ø´Ø©
            document.getElementById('messagesList').innerHTML = '';
            
            // Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø«
            isSearching = true;
            startSearchingUI();
            searchRandomLogic();
        }

        function setupChatConnection() {
            conn.on('data', data => addMessage(data, 'remote'));
            conn.on('close', () => {
                addSystemMsg("Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„. Ø§Ø¶ØºØ· Ø§Ù„ØªØ§Ù„ÙŠ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† ØºÙŠØ±Ù‡.");
                conn = null;
            });
        }

        function setupVideoCall() {
            call.on('stream', remoteStream => {
                document.getElementById('remoteVideo').srcObject = remoteStream;
            });
            call.on('close', () => {
                document.getElementById('remoteVideo').srcObject = null;
            });
        }

        // Ø§Ù„Ø´Ø§Øª
        function sendMessage() {
            const input = document.getElementById('msgInput');
            const msg = input.value;
            if(msg && conn && conn.open) {
                conn.send(msg);
                addMessage(msg, 'me');
                input.value = '';
            }
        }

        function addMessage(msg, type) {
            const container = document.getElementById('messagesList');
            const div = document.createElement('div');
            div.className = 'message ' + (type === 'me' ? 'msg-me' : 'msg-remote');
            div.innerText = msg;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function addSystemMsg(txt) {
            const container = document.getElementById('messagesList');
            const div = document.createElement('div');
            div.style.textAlign = 'center';
            div.style.color = '#777';
            div.style.fontSize = '0.8rem';
            div.style.margin = '10px 0';
            div.innerText = txt;
            container.appendChild(div);
        }

        function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }

    </script>
</body>
</html>
